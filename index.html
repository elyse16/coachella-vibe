<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COACHELLA</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap');

  :root {
    --sunset-orange: #FF6B35;
    --desert-gold: #F7C548;
    --palm-green: #2D6A4F;
    --night-purple: #5A189A;
    --hot-pink: #FF006E;
    --deep-black: #0A0A0A;
    --sand: #FAF0E6;
    --glass: rgba(255,255,255,0.07);
    --glass-border: rgba(255,255,255,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--deep-black);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated gradient background */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(90,24,154,0.3) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, rgba(255,107,53,0.2) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 80%, rgba(255,0,110,0.15) 0%, transparent 50%);
    z-index: 0;
    animation: bgShift 15s ease-in-out infinite alternate;
  }

  @keyframes bgShift {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    text-align: center;
    padding: 40px 0 20px;
  }

  .header h1 {
    font-family: 'Dela Gothic One', cursive;
    font-size: clamp(2rem, 6vw, 3.5rem);
    background: linear-gradient(135deg, var(--desert-gold), var(--sunset-orange), var(--hot-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 2px;
    line-height: 1.1;
  }

  .header .subtitle {
    font-size: 0.95rem;
    color: rgba(255,255,255,0.5);
    margin-top: 8px;
    font-weight: 300;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  /* â”€â”€ LOGIN SCREEN â”€â”€ */
  #login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    text-align: center;
    gap: 30px;
  }

  .login-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 50px 40px;
    backdrop-filter: blur(20px);
    max-width: 480px;
    width: 100%;
  }

  .login-card p {
    color: rgba(255,255,255,0.6);
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 30px;
  }

  .btn-spotify {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    background: #1DB954;
    color: #fff;
    border: none;
    border-radius: 50px;
    padding: 16px 36px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1.05rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
  }

  .btn-spotify:hover {
    background: #1ed760;
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(29,185,84,0.4);
  }

  .btn-spotify svg { width: 24px; height: 24px; }

  /* â”€â”€ STATS BAR â”€â”€ */
  .stats-bar {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 20px 0;
  }

  .stat-chip {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px 18px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stat-chip .num {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--desert-gold);
  }

  .stat-chip .label {
    color: rgba(255,255,255,0.5);
    font-weight: 300;
  }

  /* â”€â”€ NOW PLAYING â”€â”€ */
  #player-section { display: none; }

  .now-playing {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 30px;
    backdrop-filter: blur(20px);
    text-align: center;
    margin: 20px 0;
    position: relative;
    overflow: hidden;
  }

  .now-playing::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--sunset-orange), var(--hot-pink), var(--night-purple));
  }

  .np-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: rgba(255,255,255,0.4);
    margin-bottom: 20px;
  }

  .np-album-art {
    width: 200px;
    height: 200px;
    border-radius: 16px;
    margin: 0 auto 20px;
    background: rgba(255,255,255,0.05);
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .np-album-art img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .np-track-name {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 6px;
    color: #fff;
  }

  .np-artist-name {
    font-size: 1rem;
    color: var(--desert-gold);
    font-weight: 500;
    margin-bottom: 4px;
  }

  .np-artist-count {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.35);
    margin-bottom: 20px;
  }

  /* Playback controls */
  .playback-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 24px;
  }

  .ctrl-btn {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.2s;
    padding: 8px;
    border-radius: 50%;
  }

  .ctrl-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }

  .ctrl-btn.play-pause {
    background: #fff;
    color: var(--deep-black);
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  .ctrl-btn.play-pause:hover {
    transform: scale(1.08);
    background: var(--desert-gold);
  }

  /* â”€â”€ RATING STARS â”€â”€ */
  .rating-section {
    margin-top: 10px;
  }

  .rating-prompt {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.4);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .stars {
    display: flex;
    justify-content: center;
    gap: 8px;
  }

  .star-btn {
    background: none;
    border: 2px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.25);
    width: 56px;
    height: 56px;
    border-radius: 14px;
    font-size: 1.3rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'DM Sans', sans-serif;
  }

  .star-btn:hover {
    border-color: var(--desert-gold);
    color: var(--desert-gold);
    background: rgba(247,197,72,0.1);
    transform: translateY(-3px);
  }

  .star-btn.active {
    background: var(--desert-gold);
    border-color: var(--desert-gold);
    color: var(--deep-black);
    font-weight: 700;
  }

  /* â”€â”€ SKIP â”€â”€ */
  .skip-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.4);
    border-radius: 50px;
    padding: 10px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    margin-top: 16px;
    transition: all 0.2s;
  }

  .skip-btn:hover {
    border-color: rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.7);
  }

  /* â”€â”€ TABS â”€â”€ */
  .tab-bar {
    display: flex;
    gap: 0;
    margin: 20px 0 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .tab-btn {
    background: none;
    border: none;
    color: rgba(255,255,255,0.4);
    padding: 14px 24px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .tab-btn.active {
    color: var(--desert-gold);
    border-bottom-color: var(--desert-gold);
  }

  .tab-btn:hover:not(.active) { color: rgba(255,255,255,0.7); }

  /* â”€â”€ LEADERBOARD â”€â”€ */
  .leaderboard {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .lb-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-radius: 12px;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    transition: all 0.3s;
    gap: 14px;
  }

  .lb-row.eliminated {
    opacity: 0.35;
    border-color: rgba(255,0,0,0.15);
  }

  .lb-row.eliminated .lb-status { color: #ff4444; }

  .lb-rank {
    font-weight: 700;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.3);
    min-width: 28px;
    text-align: center;
  }

  .lb-info { flex: 1; min-width: 0; }

  .lb-name {
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lb-meta {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.35);
    margin-top: 2px;
  }

  .lb-avg {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--desert-gold);
    min-width: 40px;
    text-align: right;
  }

  .lb-status {
    font-size: 0.75rem;
    font-weight: 600;
    min-width: 60px;
    text-align: center;
    padding: 4px 10px;
    border-radius: 6px;
  }

  .lb-status.kept { color: #2D6A4F; background: rgba(45,106,79,0.15); }
  .lb-status.pending { color: rgba(255,255,255,0.3); }
  .lb-status.eliminated { color: #ff4444; background: rgba(255,0,0,0.1); }

  /* â”€â”€ ELIMINATED TAB â”€â”€ */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* â”€â”€ FINISH BUTTON â”€â”€ */
  .finish-section {
    text-align: center;
    margin: 30px 0;
  }

  .btn-finish {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--sunset-orange), var(--hot-pink));
    color: #fff;
    border: none;
    border-radius: 50px;
    padding: 16px 36px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-finish:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(255,0,110,0.3);
  }

  .btn-finish:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* â”€â”€ RESULTS SCREEN â”€â”€ */
  #results-screen { display: none; }

  .results-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 40px;
    backdrop-filter: blur(20px);
    text-align: center;
    margin: 20px 0;
  }

  .results-card h2 {
    font-family: 'Dela Gothic One', cursive;
    font-size: 1.8rem;
    background: linear-gradient(135deg, var(--desert-gold), var(--hot-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
  }

  .results-card p {
    color: rgba(255,255,255,0.5);
    margin-bottom: 20px;
  }

  .btn-playlist {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #1DB954;
    color: #fff;
    border: none;
    border-radius: 50px;
    padding: 14px 32px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
  }

  .btn-playlist:hover {
    background: #1ed760;
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(29,185,84,0.4);
  }

  .btn-restart {
    background: none;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.6);
    border-radius: 50px;
    padding: 12px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 16px;
    transition: all 0.2s;
  }

  .btn-restart:hover {
    border-color: rgba(255,255,255,0.4);
    color: #fff;
  }

  /* â”€â”€ LOADING â”€â”€ */
  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(10,10,10,0.9);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
  }

  .loading-overlay.active { display: flex; }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--desert-gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: rgba(255,255,255,0.5);
    font-size: 0.9rem;
  }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--glass);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
    padding: 14px 28px;
    border-radius: 14px;
    font-size: 0.9rem;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 200;
    text-align: center;
    max-width: 90%;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.eliminated-toast { border-color: rgba(255,68,68,0.3); }
  .toast.kept-toast { border-color: rgba(45,106,79,0.3); }

  /* â”€â”€ PROGRESS BAR â”€â”€ */
  .progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
    margin: 16px 0;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--sunset-orange), var(--hot-pink));
    border-radius: 2px;
    transition: width 0.5s ease;
    width: 0%;
  }

  /* â”€â”€ ERROR â”€â”€ */
  .error-msg {
    background: rgba(255,68,68,0.1);
    border: 1px solid rgba(255,68,68,0.2);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 16px 0;
    font-size: 0.9rem;
    color: #ff8888;
    text-align: center;
    display: none;
  }

  .error-msg.show { display: block; }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 600px) {
    .container { padding: 12px; }
    .now-playing { padding: 20px; }
    .np-album-art { width: 160px; height: 160px; }
    .star-btn { width: 48px; height: 48px; font-size: 1.1rem; }
    .login-card { padding: 30px 20px; }
    .lb-row { padding: 10px 12px; gap: 10px; }
  }
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="header">
    <h1>COACHELLA</h1>
    <div class="subtitle">2026 Â· Taste Test Your Lineup</div>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div class="login-card">
      <p>Connect your Spotify Premium account to play songs from every Coachella 2026 artist. Rate each track, eliminate the ones that don't vibe, and build your dream lineup.</p>
      <button class="btn-spotify" onclick="loginSpotify()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        Connect with Spotify
      </button>
    </div>
  </div>

  <!-- PLAYER SECTION -->
  <div id="player-section">
    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-chip">
        <span class="num" id="stat-remaining">0</span>
        <span class="label">in play</span>
      </div>
      <div class="stat-chip">
        <span class="num" id="stat-eliminated">0</span>
        <span class="label">eliminated</span>
      </div>
      <div class="stat-chip">
        <span class="num" id="stat-rated">0</span>
        <span class="label">songs rated</span>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>

    <!-- Now Playing Card -->
    <div class="now-playing">
      <div class="np-label">Now Playing</div>
      <div class="np-album-art">
        <img id="np-art" src="" alt="Album art">
      </div>
      <div class="np-track-name" id="np-track">Loading...</div>
      <div class="np-artist-name" id="np-artist">â€”</div>
      <div class="np-artist-count" id="np-count"></div>

      <!-- Playback Controls -->
      <div class="playback-controls">
        <button class="ctrl-btn" onclick="previousTrack()" title="Previous">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="ctrl-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="play-icon" style="display:none"><path d="M8 5v14l11-7z"/></svg>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" id="pause-icon"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="ctrl-btn" onclick="skipToNext()" title="Next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
      </div>

      <!-- Rating -->
      <div class="rating-section">
        <div class="rating-prompt">Rate this track</div>
        <div class="stars">
          <button class="star-btn" onclick="rate(1)">1</button>
          <button class="star-btn" onclick="rate(2)">2</button>
          <button class="star-btn" onclick="rate(3)">3</button>
          <button class="star-btn" onclick="rate(4)">4</button>
          <button class="star-btn" onclick="rate(5)">5</button>
        </div>
        <button class="skip-btn" onclick="skipSong()">Skip (don't rate)</button>
      </div>
    </div>

    <div id="error-msg" class="error-msg"></div>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('active')">Active</button>
      <button class="tab-btn" onclick="switchTab('eliminated')">Eliminated</button>
      <button class="tab-btn" onclick="switchTab('all')">All Artists</button>
    </div>

    <div id="tab-active" class="tab-content active">
      <div class="leaderboard" id="leaderboard-active"></div>
    </div>
    <div id="tab-eliminated" class="tab-content">
      <div class="leaderboard" id="leaderboard-eliminated"></div>
    </div>
    <div id="tab-all" class="tab-content">
      <div class="leaderboard" id="leaderboard-all"></div>
    </div>

    <!-- Finish -->
    <div class="finish-section">
      <button class="btn-finish" id="btn-finish" onclick="finishSession()" disabled>
        Finish & Create Playlist
      </button>
      <div style="font-size:0.75rem; color:rgba(255,255,255,0.3); margin-top:8px;">
        Available after all artists have 3+ ratings
      </div>
    </div>
  </div>

  <!-- RESULTS SCREEN -->
  <div id="results-screen">
    <div class="results-card">
      <h2>YOUR LINEUP</h2>
      <p id="results-summary"></p>
      <button class="btn-playlist" id="btn-create-playlist" onclick="createPlaylist()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        Create Spotify Playlist
      </button>
      <br>
      <button class="btn-restart" onclick="restartSession()">Start Over</button>
    </div>
    <div class="leaderboard" id="results-leaderboard"></div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">Loading your Coachella lineup...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID = 'a9efe27c3e7e4ba09df58d3b6e4448de';
// Must match your Spotify Developer App redirect URI exactly
const REDIRECT_URI = 'https://elyse16.github.io/coachella-vibe/callback';
const SCOPES = [
  'user-read-private',
  'user-read-playback-state',
  'user-modify-playback-state',
  'user-read-currently-playing',
  'playlist-modify-public',
  'playlist-modify-private',
  'streaming'
].join(' ');

const MIN_RATINGS = 3;
const ELIMINATION_THRESHOLD = 3.0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COACHELLA 2026 LINEUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COACHELLA_ARTISTS = [
  // Weekend 1 headliners & top billing
  "Sabrina Carpenter", "The xx", "Nine Inch Noize", "Disclosure",
  "Turnstile", "Ethel Cain", "Dijon", "Teddy Swims",
  "KATSEYE", "Devo", "Sexyy Red", "Central Cee",
  "Foster the People", "Levity", "Blood Orange", "Moby",
  "Marlon Hoffstadt", "Lykke Li", "fakemink", "Gordo",
  "Creepy Nuts", "Joyce Manor", "BINI", "Kettama",
  "Groove Armada", "Joost", "HUGEL", "CMAT",
  "Slayyyter", "Prospa", "Hot Mulligan", "Hamdi",
  "Fleshwater", "Max Styler", "Wednesday", "Dabeull",
  "The Two Lips", "Ninajirachi", "Max Dean x Luke Dean",
  "Cachirula & Loojan", "Jessica Brankka", "ChloÃ© Caillet x Rossi.",
  "Arodes", "NewDad", "Carolina Durante", "flowerovlove",
  "Febuary", "Bob Baker Marionettes", "Youna", "Sahar Z",
  // Weekend 2 headliners & top billing
  "Justin Bieber", "The Strokes", "GIVÄ’ON", "Addison Rae",
  "Labrinth", "SOMBR", "David Byrne", "Interpol",
  "Alex G", "Swae Lee", "Solomun", "Taemin",
  "PinkPantheress", "Royel Otis", "REZZ", "Fujii Kaze",
  "Adriatique", "Davido", "Boys Noize", "Geese",
  "rusowsky", "Green Velvet x AYYBO", "LuÃ­sa Sonza", "ZULAN",
  "Los Hermanos Flores", "Bedouin", "Ceremony", "54 Ultra",
  "Noga Erez", "Ben Sterling", "Blondshell", "Lambrini Girls",
  "Ecca Vandal", "Mind Enterprises", "Freak Slug", "SOSA",
  "Mahmut Orhan", "Riordan", "Die Spitz", "WHATMORE",
  "GENESI", "Yamagucci",
  // Weekend 3 headliners & top billing
  "Karol G", "Young Thug", "Kaskade", "BIGBANG",
  "Laufey", "Major Lazer", "Iggy Pop", "FKA twigs",
  "Wet Leg", "Clipse", "Subtronics", "Little Simz",
  "Mochakk", "Duke Dumont", "Worship",
  "Armin van Buuren x Adam Beyer", "Holly Humberstone",
  "Gigi Perez", "The Rapture", "Suicidal Tendencies",
  "BUNT.", "French Police", "Black Flag", "Oklou",
  "RÃ¶yksopp", "The Chats", "DRAIN", "Model/Actriz",
  "COBRAH", "Los Retros", "WhoMadeWho", "Jane Remover",
  "RÃ˜Z", "Glitterer", "Carlita x Josh Baker", "MÃ‹STIZA",
  "&friends", "AZZECCA", "LE YORA", "Samia", "Tomora"
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let accessToken = null;
let userId = null;
let artists = {}; // { name: { tracks: [], ratings: [], eliminated: false, avgRating: 0 } }
let songQueue = []; // shuffled array of { artist, track }
let currentSong = null;
let isPlaying = false;
let totalRated = 0;
let deviceId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loginSpotify() {
  // Generate PKCE verifier and challenge
  const verifier = generateRandomString(128);
  localStorage.setItem('pkce_verifier', verifier);

  generateCodeChallenge(verifier).then(challenge => {
    const params = new URLSearchParams({
      client_id: CLIENT_ID,
      response_type: 'code',
      redirect_uri: REDIRECT_URI,
      scope: SCOPES,
      code_challenge_method: 'S256',
      code_challenge: challenge,
      show_dialog: 'true'
    });
    window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
  });
}

function generateRandomString(length) {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const values = crypto.getRandomValues(new Uint8Array(length));
  return values.reduce((acc, x) => acc + possible[x % possible.length], '');
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function exchangeCode(code) {
  const verifier = localStorage.getItem('pkce_verifier');
  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    })
  });
  const data = await response.json();
  if (data.access_token) {
    accessToken = data.access_token;
    localStorage.setItem('spotify_token', accessToken);
    localStorage.setItem('spotify_token_time', Date.now().toString());
    localStorage.setItem('spotify_scopes', SCOPES);
    // Clean up URL
    window.history.replaceState({}, document.title, REDIRECT_URI);
    await initApp();
  } else {
    showError('Failed to authenticate with Spotify. Please try again.');
    console.error('Token exchange failed:', data);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPOTIFY API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPOTIFY_RETRY_MAX = 3;
async function spotifyFetch(endpoint, options = {}, retriesLeft = SPOTIFY_RETRY_MAX) {
  const url = endpoint.startsWith('http') ? endpoint : `https://api.spotify.com/v1${endpoint}`;
  const res = await fetch(url, {
    ...options,
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
  if (res.status === 401) {
    showError('Session expired. Please reconnect.');
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('player-section').style.display = 'none';
    return null;
  }
  if (res.status === 204 || res.status === 202) return {};
  // Retry on rate limit (429) or quota/forbidden (403) with backoff
  if ((res.status === 403 || res.status === 429) && retriesLeft > 0) {
    const retrySec = res.headers.get('Retry-After');
    const waitMs = retrySec ? Math.min(parseInt(retrySec, 10) * 1000, 15000) : Math.min(2000 * Math.pow(2, SPOTIFY_RETRY_MAX - retriesLeft), 12000);
    await sleep(waitMs);
    return spotifyFetch(endpoint, options, retriesLeft - 1);
  }
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    console.error('Spotify API error:', res.status, err);
    return null;
  }
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let loadingInBackground = false;

async function initApp() {
  showLoading('Connecting to Spotify...');
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('player-section').style.display = 'block';

  // Get user ID
  const me = await spotifyFetch('/me');
  if (!me) { hideLoading(); return; }
  userId = me.id;

  // Start in-browser Spotify player
  showLoading('Starting Spotify player...');
  const playerReady = await initWebPlayer();
  if (!playerReady) {
    await ensureDevice();
  }

  // Check for saved session
  const saved = localStorage.getItem('vibe_session');
  if (saved) {
    try {
      const session = JSON.parse(saved);
      artists = session.artists;
      totalRated = session.totalRated;
      songQueue = session.songQueue || [];
      if (songQueue.length === 0) buildQueue();
      updateStats();
      renderLeaderboards();
      checkFinishEligibility();
      hideLoading();
      playNext();
      return;
    } catch(e) {
      console.log('Could not restore session, starting fresh');
    }
  }

  // No saved session: start loading artists in the background
  hideLoading();
  loadArtistTracksInBackground();
}

async function loadArtistTracksInBackground() {
  loadingInBackground = true;
  artists = {};
  let loaded = 0;
  let firstSongPlayed = false;

  for (const name of COACHELLA_ARTISTS) {
    document.getElementById('progress-fill').style.width =
      ((loaded / COACHELLA_ARTISTS.length) * 100) + '%';

    // Search for tracks by this artist (top-tracks endpoint removed in Feb 2026 dev mode)
    const searchRes = await spotifyFetch(
      `/search?q=${encodeURIComponent('artist:' + name)}&type=track&limit=10`
    );
    if (!searchRes || !searchRes.tracks || !searchRes.tracks.items.length) {
      console.warn(`No tracks found for: ${name}`);
      loaded++;
      await sleep(450);
      continue;
    }

    const tracks = searchRes.tracks.items.map(t => ({
      id: t.id,
      uri: t.uri,
      name: t.name,
      album: t.album?.name || '',
      art: t.album?.images?.[0]?.url || '',
      duration_ms: t.duration_ms
    }));

    // Get the artist's Spotify ID from the first track result
    const firstArtist = searchRes.tracks.items[0]?.artists?.[0];

    artists[name] = {
      spotifyId: firstArtist?.id || '',
      tracks: tracks,
      ratings: [],
      eliminated: false,
      avgRating: 0
    };

    for (const track of tracks) {
      const pos = Math.floor(Math.random() * (songQueue.length + 1));
      songQueue.splice(pos, 0, { artist: name, track });
    }

    loaded++;
    updateStats();
    renderLeaderboards();

    if (!firstSongPlayed && songQueue.length > 0) {
      firstSongPlayed = true;
      playNext();
    }

    await sleep(450);
  }

  loadingInBackground = false;
  checkFinishEligibility();
  saveSession();
  showToast(`All ${Object.keys(artists).length} artists loaded!`, 'kept-toast');
}

function buildQueue() {
  songQueue = [];
  for (const [artistName, data] of Object.entries(artists)) {
    if (data.eliminated) continue;
    for (const track of data.tracks) {
      songQueue.push({ artist: artistName, track: track });
    }
  }
  // Shuffle
  for (let i = songQueue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [songQueue[i], songQueue[j]] = [songQueue[j], songQueue[i]];
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB PLAYBACK SDK (in-browser player)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let spotifyPlayer = null;
let sdkReady = false;

window.onSpotifyWebPlaybackSDKReady = () => { sdkReady = true; };

function initWebPlayer() {
  return new Promise((resolve) => {
    function tryInit() {
      if (!sdkReady) { setTimeout(tryInit, 200); return; }
      spotifyPlayer = new Spotify.Player({
        name: 'Coachella Vibe',
        getOAuthToken: cb => cb(accessToken),
        volume: 0.8
      });
      spotifyPlayer.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        console.log('Web player ready, device:', device_id);
        resolve(true);
      });
      spotifyPlayer.addListener('not_ready', () => {
        console.warn('Web player went offline');
      });
      spotifyPlayer.addListener('initialization_error', ({ message }) => {
        console.error('SDK init error:', message);
        resolve(false);
      });
      spotifyPlayer.addListener('authentication_error', ({ message }) => {
        console.error('SDK auth error:', message);
        resolve(false);
      });
      spotifyPlayer.addListener('playback_error', ({ message }) => {
        console.error('SDK playback error:', message);
      });
      spotifyPlayer.addListener('player_state_changed', (state) => {
        if (!state) return;
        isPlaying = !state.paused;
        updatePlayPauseIcon();
      });
      spotifyPlayer.connect();
    }
    tryInit();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVICE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function ensureDevice() {
  if (deviceId) return true;
  // Fallback: check for external devices
  const devRes = await spotifyFetch('/me/player/devices');
  if (devRes && devRes.devices && devRes.devices.length > 0) {
    const active = devRes.devices.find(d => d.is_active);
    deviceId = active ? active.id : devRes.devices[0].id;
    return true;
  }
  showError('No playback device available. Please make sure you have Spotify Premium and allow audio in your browser.');
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function playNext() {
  // Remove songs from eliminated artists
  songQueue = songQueue.filter(s => !artists[s.artist]?.eliminated);

  if (songQueue.length === 0) {
    // Rebuild queue from non-eliminated artists with unplayed or less-played tracks
    buildQueue();
    if (songQueue.length === 0) {
      showToast('All songs have been played! Check your results.');
      return;
    }
  }

  currentSong = songQueue.shift();
  updateNowPlaying();

  // Play on Spotify
  const hasDevice = await ensureDevice();
  if (!hasDevice) return;

  const res = await spotifyFetch(`/me/player/play?device_id=${deviceId}`, {
    method: 'PUT',
    body: JSON.stringify({ uris: [currentSong.track.uri] })
  });

  if (res === null) {
    showError('Playback failed. Make sure Spotify is open and active.');
  } else {
    isPlaying = true;
    updatePlayPauseIcon();
    hideError();
  }
}

function updateNowPlaying() {
  if (!currentSong) return;
  document.getElementById('np-art').src = currentSong.track.art || '';
  document.getElementById('np-track').textContent = currentSong.track.name;
  document.getElementById('np-artist').textContent = currentSong.artist;

  const artistData = artists[currentSong.artist];
  if (artistData) {
    const count = artistData.ratings.length;
    document.getElementById('np-count').textContent =
      count === 0 ? 'First song from this artist' :
      `${count} song${count > 1 ? 's' : ''} rated Â· avg ${artistData.avgRating.toFixed(1)}`;
  }

  // Reset star highlights
  document.querySelectorAll('.star-btn').forEach(b => b.classList.remove('active'));
}

async function togglePlayPause() {
  if (spotifyPlayer) {
    await spotifyPlayer.togglePlay();
  } else if (isPlaying) {
    await spotifyFetch('/me/player/pause', { method: 'PUT' });
    isPlaying = false;
    updatePlayPauseIcon();
  } else {
    await spotifyFetch('/me/player/play', { method: 'PUT' });
    isPlaying = true;
    updatePlayPauseIcon();
  }
}

function updatePlayPauseIcon() {
  document.getElementById('play-icon').style.display = isPlaying ? 'none' : 'block';
  document.getElementById('pause-icon').style.display = isPlaying ? 'block' : 'none';
}

async function skipToNext() {
  playNext();
}

async function previousTrack() {
  // Restart current track
  if (currentSong) {
    await spotifyFetch(`/me/player/play?device_id=${deviceId}`, {
      method: 'PUT',
      body: JSON.stringify({ uris: [currentSong.track.uri] })
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rate(score) {
  if (!currentSong) return;

  const artistName = currentSong.artist;
  const artistData = artists[artistName];
  if (!artistData) return;

  // Highlight selected rating
  document.querySelectorAll('.star-btn').forEach((b, i) => {
    b.classList.toggle('active', i < score);
  });

  // Record rating
  artistData.ratings.push({
    trackId: currentSong.track.id,
    trackName: currentSong.track.name,
    score: score
  });

  // Recalculate average
  const sum = artistData.ratings.reduce((a, r) => a + r.score, 0);
  artistData.avgRating = sum / artistData.ratings.length;

  totalRated++;

  // Check elimination
  if (artistData.ratings.length >= MIN_RATINGS && !artistData.eliminated) {
    if (artistData.avgRating < ELIMINATION_THRESHOLD) {
      artistData.eliminated = true;
      showToast(`âŒ ${artistName} eliminated (avg: ${artistData.avgRating.toFixed(1)})`, 'eliminated-toast');
    } else if (artistData.ratings.length === MIN_RATINGS) {
      showToast(`âœ… ${artistName} survives! (avg: ${artistData.avgRating.toFixed(1)})`, 'kept-toast');
    }
  }

  updateStats();
  renderLeaderboards();
  checkFinishEligibility();
  saveSession();

  // Auto-advance after brief delay
  setTimeout(() => playNext(), 800);
}

function skipSong() {
  playNext();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS & UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const active = Object.values(artists).filter(a => !a.eliminated).length;
  const eliminated = Object.values(artists).filter(a => a.eliminated).length;

  document.getElementById('stat-remaining').textContent = active;
  document.getElementById('stat-eliminated').textContent = eliminated;
  document.getElementById('stat-rated').textContent = totalRated;

  // Progress: based on how many artists have 3+ ratings
  const total = Object.keys(artists).length;
  const evaluated = Object.values(artists).filter(a => a.ratings.length >= MIN_RATINGS).length;
  const pct = total > 0 ? (evaluated / total * 100) : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
}

function renderLeaderboards() {
  // Active artists sorted by avg rating desc
  const activeArtists = Object.entries(artists)
    .filter(([_, a]) => !a.eliminated)
    .sort((a, b) => b[1].avgRating - a[1].avgRating || b[1].ratings.length - a[1].ratings.length);

  const eliminatedArtists = Object.entries(artists)
    .filter(([_, a]) => a.eliminated)
    .sort((a, b) => b[1].avgRating - a[1].avgRating);

  const allArtists = Object.entries(artists)
    .sort((a, b) => b[1].avgRating - a[1].avgRating || b[1].ratings.length - a[1].ratings.length);

  document.getElementById('leaderboard-active').innerHTML = activeArtists.map(([name, data], i) =>
    renderRow(name, data, i + 1, false)
  ).join('');

  document.getElementById('leaderboard-eliminated').innerHTML = eliminatedArtists.length > 0
    ? eliminatedArtists.map(([name, data], i) => renderRow(name, data, i + 1, true)).join('')
    : '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:30px;">No artists eliminated yet</div>';

  document.getElementById('leaderboard-all').innerHTML = allArtists.map(([name, data], i) =>
    renderRow(name, data, i + 1, data.eliminated)
  ).join('');
}

function renderRow(name, data, rank, isEliminated) {
  const statusClass = isEliminated ? 'eliminated' :
    data.ratings.length >= MIN_RATINGS ? 'kept' : 'pending';
  const statusText = isEliminated ? 'OUT' :
    data.ratings.length >= MIN_RATINGS ? 'IN' : `${data.ratings.length}/${MIN_RATINGS}`;

  return `
    <div class="lb-row ${isEliminated ? 'eliminated' : ''}">
      <div class="lb-rank">${rank}</div>
      <div class="lb-info">
        <div class="lb-name">${name}</div>
        <div class="lb-meta">${data.ratings.length} rated Â· ${data.tracks.length} tracks available</div>
      </div>
      <div class="lb-avg">${data.ratings.length > 0 ? data.avgRating.toFixed(1) : 'â€”'}</div>
      <div class="lb-status ${statusClass}">${statusText}</div>
    </div>
  `;
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  event.target.classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

function checkFinishEligibility() {
  const total = Object.keys(artists).length;
  const evaluated = Object.values(artists).filter(a => a.ratings.length >= MIN_RATINGS || a.eliminated).length;
  const btn = document.getElementById('btn-finish');
  btn.disabled = evaluated < total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINISH / RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function finishSession() {
  // Pause playback
  await spotifyFetch('/me/player/pause', { method: 'PUT' }).catch(() => {});

  const survivors = Object.entries(artists)
    .filter(([_, a]) => !a.eliminated)
    .sort((a, b) => b[1].avgRating - a[1].avgRating);

  const eliminated = Object.entries(artists).filter(([_, a]) => a.eliminated);

  document.getElementById('player-section').style.display = 'none';
  document.getElementById('results-screen').style.display = 'block';

  document.getElementById('results-summary').textContent =
    `${survivors.length} artists survived out of ${Object.keys(artists).length}. ${eliminated.length} eliminated.`;

  document.getElementById('results-leaderboard').innerHTML =
    survivors.map(([name, data], i) => renderRow(name, data, i + 1, false)).join('');
}

async function createPlaylist() {
  showLoading('Creating your Coachella playlist...');

  const survivors = Object.entries(artists)
    .filter(([_, a]) => !a.eliminated)
    .sort((a, b) => b[1].avgRating - a[1].avgRating);

  // Create playlist
  const playlist = await spotifyFetch('/me/playlists', {
    method: 'POST',
    body: JSON.stringify({
      name: 'My Coachella 2026 Lineup ðŸŒ´',
      description: `Curated by Vibe Code â€” ${survivors.length} artists, rated and approved.`,
      public: true
    })
  });

  if (!playlist || !playlist.id) {
    hideLoading();
    showError('Failed to create playlist.');
    return;
  }

  // Collect top-rated tracks from each surviving artist
  const trackUris = [];
  for (const [name, data] of survivors) {
    // Get the highest-rated tracks for this artist
    const ratedTracks = data.ratings
      .sort((a, b) => b.score - a.score)
      .slice(0, 3); // Top 3 rated tracks

    for (const r of ratedTracks) {
      const trackObj = data.tracks.find(t => t.id === r.trackId);
      if (trackObj) {
        trackUris.push(trackObj.uri);
      }
    }
  }

  // Deduplicate
  const uniqueUris = [...new Set(trackUris)];

  // Add tracks in batches of 100
  for (let i = 0; i < uniqueUris.length; i += 100) {
    const batch = uniqueUris.slice(i, i + 100);
    await spotifyFetch(`/playlists/${playlist.id}/tracks`, {
      method: 'POST',
      body: JSON.stringify({ uris: batch })
    });
  }

  hideLoading();
  showToast(`ðŸŽ‰ Playlist created with ${uniqueUris.length} tracks!`, 'kept-toast');

  // Update button
  const btn = document.getElementById('btn-create-playlist');
  btn.textContent = 'âœ“ Playlist Created!';
  btn.style.background = '#2D6A4F';
  btn.onclick = () => window.open(playlist.external_urls?.spotify || 'https://open.spotify.com', '_blank');
}

function restartSession() {
  localStorage.removeItem('vibe_session');
  totalRated = 0;
  songQueue = [];
  currentSong = null;
  document.getElementById('results-screen').style.display = 'none';
  document.getElementById('player-section').style.display = 'block';
  loadArtistTracksInBackground();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSession() {
  try {
    localStorage.setItem('vibe_session', JSON.stringify({
      artists: artists,
      totalRated: totalRated,
      songQueue: songQueue.slice(0, 50) // Only save next 50 to save space
    }));
  } catch(e) {
    console.warn('Could not save session:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(text) {
  document.getElementById('loading-text').textContent = text || 'Loading...';
  document.getElementById('loading').classList.add('active');
}

function hideLoading() {
  document.getElementById('loading').classList.remove('active');
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.classList.add('show');
}

function hideError() {
  document.getElementById('error-msg').classList.remove('show');
}

function showToast(msg, extraClass = '') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast ' + extraClass;
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => toast.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot() {
  // Check for auth code in URL
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');

  if (code) {
    showLoading('Authenticating with Spotify...');
    await exchangeCode(code);
    return;
  }

  // Check for existing token
  const token = localStorage.getItem('spotify_token');
  const tokenTime = parseInt(localStorage.getItem('spotify_token_time') || '0');
  const isExpired = Date.now() - tokenTime > 3500000; // ~58 min
  const savedScopes = localStorage.getItem('spotify_scopes') || '';
  const scopesChanged = savedScopes !== SCOPES;

  if (token && !isExpired && !scopesChanged) {
    accessToken = token;
    // Verify token is still valid
    const me = await spotifyFetch('/me');
    if (me) {
      await initApp();
      return;
    }
  }

  // Show login
  document.getElementById('login-screen').style.display = 'flex';
})();
</script>

</body>
</html>
